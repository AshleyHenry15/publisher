set shell := ["bash", "-uc"]

export TARGET_SERVER := env_var_or_default("TARGET_SERVER", "http://localhost:3939")
# export API_KEY := env_var_or_default("PERFTEST_API_KEY", `echo -n admin | md5sum | cut -f1 -d" "`)

test target: 
  just run-connect cli-client {{target}} ui-client {{target}} test-cypress {{target}} stop

build target:
  #!/usr/bin/env bash
  if [[ {{target}} =~ "all" ]]; then
    docker compose build
    else
    docker compose build {{target}}
  fi

test-cli target:
  just cli-client {{target}}

test-cypress target:
  #!/usr/bin/env bash
  just ui-client {{target}}
  sleep 5
  CYPRESS_BASE_URL=$(docker logs --tail 2 {{target}}-client-ui | grep '^http.*#.*') \
  just cypress {{target}}

ui-client target:
  #!/usr/bin/env bash
  if [[ {{target}} =~ "linux" ]]; then
    BINARY_PATH=/publishing-client/bin/{{target}}/connect-client \
    docker compose up -d \
    {{target}}-client-ui
  elif [[ {{target}} =~ "windows" ]]; then
    $BINARY_PATH account-ui windows-amd64 --listen=localhost:9999
  elif [[ {{target}} =~ "macos" ]]; then
     $BINARY_PATH account-ui account-ui --listen=localhost:9999
  fi

# _run-ui-client target:
#   $BINARY_PATH account-ui --listen=localhost:9999

cypress target:
  #!/usr/bin/env bash
  docker compose up cypress

cli-client target:
  #!/usr/bin/env bash
  timeout 100 bash -c \
    'while [[ "$(curl -s -o /dev/null -w ''%{http_code}'' ${TARGET_SERVER}/__ping__)" != "200" ]]; \
        do sleep 5; \
        echo "waiting for connect..."; \
        done'

  if [[ {{target}} =~ "linux" ]]; then
    docker compose run \
    -e BATS_SUPPORT_LIB="/libs/bats-support/load" \
    -e BATS_ASSERT_LIB="/libs/bats-assert/load" \
    -e BINARY_PATH=/publishing-client/bin/{{target}}/connect-client \
    --rm --remove-orphans {{target}} just _test-cli-client {{target}}
  elif [[ {{target}} =~ "windows" ]]; then
    just _test-cli-client windows-amd64
  elif [[ {{target}} =~ "macos" ]]; then
    just _test-cli-client darwin-amd64
  fi

_test-cli-client target:
  bats --tap -T -r ./bats/

run-ui-local target:
  #!/usr/bin/env bash
  just run-connect && \
  
  just bats-install && \
  BATS_SUPPORT_LIB={{invocation_directory()}}/libs/bats-support/load \
  BATS_ASSERT_LIB={{invocation_directory()}}/libs/bats-assert/load \
  BINARY_PATH=../bin/{{target}}/connect-client \
  ./libs/bats-core/bin/bats --tap -T -r ./bats/

bats-install:
  #!/usr/bin/env bash
  if [[ ! -d ./libs ]]; then
    git clone --depth=1 https://github.com/bats-core/bats-core.git ./libs/bats-core && \
    ./libs/bats-core/install.sh ./libs/bats-core/installation && \
    git clone --depth=1 https://github.com/ztombol/bats-support.git ./libs/bats-support && \
    git clone --depth=1 https://github.com/ztombol/bats-assert.git ./libs/bats-assert
  fi

run-connect:
  docker compose up -d connect

run-cypress:
  docker compose up --exit-code-from cypress

bash target:
  docker compose run --rm {{target}} /bin/bash

stop: 
  docker compose kill
